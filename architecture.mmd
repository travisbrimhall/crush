flowchart TB
    subgraph External["External Context Sources"]
        VSCode["VS Code Extension"]
        Browser["Browser Extension"]
        Terminal["Terminal/CLI"]
    end

    subgraph LocalAPI["Local API Server"]
        APIServer["HTTP Server :9119"]
        ContextEndpoint["POST /context"]
        SubmitEndpoint["POST /submit"]
        StatusEndpoint["GET /status"]
    end

    subgraph UI["TUI Layer"]
        Model["ui/model"]
        Chat["Chat View"]
        Input["Input Handler"]
        ContextBlock["Context Block (styled)"]
    end

    subgraph Coordinator["Agent Coordinator"]
        Coord["coordinator"]
        ProviderOpts["getProviderOptions()"]
        BuildAgent["buildAgent()"]
        BuildTools["buildTools()"]
    end

    subgraph Agent["Session Agent"]
        SA["sessionAgent"]
        Run["Run()"]
        PreparePrompt["preparePrompt()"]
        Summarize["Summarize()"]
    end

    subgraph Providers["AI Providers (fantasy)"]
        Anthropic
        OpenAI
        Google
        Azure
        Bedrock
        OpenRouter
    end

    subgraph Services["Data Services"]
        Sessions["session.Service"]
        Messages["message.Service"]
        Memory["memory.MemoryStore"]
        LSP["lsp.Manager"]
        Permissions["permission.Service"]
        PubSub["pubsub.Broker"]
    end

    subgraph Tools["Agent Tools"]
        Bash
        Grep
        View
        Edit
        Fetch
        SubAgent["Sub-Agent"]
    end

    subgraph MCP["MCP Servers (outbound)"]
        VSCodeMCP["VS Code MCP"]
        DockerMCP["Docker MCP"]
        OtherMCP["Other MCPs"]
    end

    %% External context flow (inbound)
    VSCode -->|"POST diagnostic/selection"| ContextEndpoint
    Browser -->|"POST console error/network"| ContextEndpoint
    Terminal -->|"POST test failure"| ContextEndpoint

    ContextEndpoint -->|"injects context"| PubSub
    SubmitEndpoint -->|"context + auto-run"| Coord
    PubSub -->|"tea.Msg"| Model
    Model -->|"renders"| ContextBlock

    %% Standard conversation flow
    Input -->|"user prompt"| Model
    Model -->|"Run()"| Coord
    Coord -->|"mergeCallOptions()"| ProviderOpts
    Coord -->|"builds"| BuildAgent
    BuildAgent -->|"creates"| SA
    Coord -->|"registers"| BuildTools
    BuildTools --> Tools

    SA -->|"Run()"| Run
    Run -->|"converts messages"| PreparePrompt
    Run -->|"streams"| Providers
    Run -->|"executes"| Tools
    Run -->|"at 80% context"| Summarize

    %% Tool backends (outbound)
    Tools -->|"highlight, open file"| VSCodeMCP
    Tools -->|"logs, exec, compose"| DockerMCP
    Tools -->|"other actions"| OtherMCP

    Coord -.->|"reads/writes"| Sessions
    Coord -.->|"reads/writes"| Messages
    SA -.->|"reads"| Memory
    SA -.->|"diagnostics"| LSP
    Tools -.->|"checks"| Permissions

    Providers -->|"streaming response"| SA
    SA -->|"AgentResult"| Coord
    Coord -->|"tea.Msg"| Model
    Model -->|"renders"| Chat
